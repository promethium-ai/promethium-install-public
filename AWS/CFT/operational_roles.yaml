AWSTemplateFormatVersion: '2010-09-09'
Description: 'EKS Addon Roles and Service Account Roles for Promethium EKS Cluster'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Tagging Options"
        Parameters:
          - TagMode
          - CustomTags
      - Label:
          default: "EKS Role Configuration"
        Parameters:
          - ClusterName
          - OIDCProviderUrl
          - EBSCSIDriverRoleName
          - EFSCSIDriverRoleName
          - LoadBalancerControllerRoleName
          - ClusterAutoscalerRoleName
          - EKSClusterRoleName
          - EKSWorkerNodeRoleName
          - PGBackupServiceRoleName
          - GlueTrinoServiceRoleName
    ParameterLabels:
      TagMode:
        default: "Tag Mode"
      CustomTags:
        default: "Custom Tags (Key=Value,Key2=Value2)"

Parameters:
  ClusterName:
    Type: String
    Default: promethium-datafabric-prod-eks-cluster
    Description: Name of the EKS cluster (used for role naming and conditions)
  
  OIDCProviderUrl:
    Type: String
    Default: oidc.eks.us-east-1.amazonaws.com/id/DUMMY1234567890
    Description: OIDC Provider URL for EKS cluster (replace with actual OIDC URL)
  
  EBSCSIDriverRoleName:
    Type: String
    Default: ''
    Description: Custom name for EBS CSI Driver role (optional)
  
  EFSCSIDriverRoleName:
    Type: String
    Default: ''
    Description: Custom name for EFS CSI Driver role (optional)
  
  LoadBalancerControllerRoleName:
    Type: String
    Default: ''
    Description: Custom name for Load Balancer Controller role (optional)
  
  ClusterAutoscalerRoleName:
    Type: String
    Default: ''
    Description: Custom name for Cluster Autoscaler role (optional)
  
  EKSClusterRoleName:
    Type: String
    Default: ''
    Description: Custom name for EKS Cluster role (optional)
  
  EKSWorkerNodeRoleName:
    Type: String
    Default: ''
    Description: Custom name for EKS Worker Node role (optional)
  
  PGBackupServiceRoleName:
    Type: String
    Default: ''
    Description: Custom name for PostgreSQL Backup Service role (optional)
  
  GlueTrinoServiceRoleName:
    Type: String
    Default: ''
    Description: Custom name for Glue Trino Service role (optional)

  TagMode:
    Type: String
    Default: default
    AllowedValues:
      - default
      - custom
    Description: Choose whether to use default tags or user-supplied custom tags.

  CustomTags:
    Type: String
    Default: ""
    Description: "Custom tags in Key=Value,Key2=Value2 format (used only when TagMode=custom)"

Mappings:
  DefaultTags:
    Values:
      Environment: prod
      Product: Promethium
      Owner: support@promethium.ai
      createdBy: CloudFormation
      Project: Intelligentedge

Conditions:
  HasCustomTags: !Not [!Equals [!Ref CustomTags, ""]]
  HasCustomEBSRoleName: !Not [!Equals [!Ref EBSCSIDriverRoleName, '']]
  HasCustomEFSRoleName: !Not [!Equals [!Ref EFSCSIDriverRoleName, '']]
  HasCustomLBRoleName: !Not [!Equals [!Ref LoadBalancerControllerRoleName, '']]
  HasCustomCARoleName: !Not [!Equals [!Ref ClusterAutoscalerRoleName, '']]
  HasCustomEKSClusterRoleName: !Not [!Equals [!Ref EKSClusterRoleName, '']]
  HasCustomEKSWorkerRoleName: !Not [!Equals [!Ref EKSWorkerNodeRoleName, '']]
  HasCustomPGBackupRoleName: !Not [!Equals [!Ref PGBackupServiceRoleName, '']]
  HasCustomGlueTrinoRoleName: !Not [!Equals [!Ref GlueTrinoServiceRoleName, '']]

Resources:

  TagResolverFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Path: "/"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  TagResolverFunction:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.9
      Handler: index.lambda_handler
      Timeout: 30
      Role: !GetAtt TagResolverFunctionRole.Arn
      Code:
        ZipFile: |
          import json
          import cfnresponse

          def lambda_handler(event, context):
              try:
                  props = event.get("ResourceProperties", {})
                  tag_mode = props.get("TagMode", "default")
                  default_tags = props.get("DefaultTags", {})
                  custom_tags = props.get("CustomTags", "")

                  tags = []

                  if isinstance(default_tags, dict):
                      for k, v in default_tags.items():
                          tags.append({"Key": k, "Value": v})

                  if tag_mode == "custom" and isinstance(custom_tags, str) and custom_tags.strip() != "":
                      pairs = custom_tags.split(",")
                      for pair in pairs:
                          if "=" in pair:
                              k, v = pair.split("=", 1)
                              tags.append({"Key": k.strip(), "Value": v.strip()})

                  response_data = {"Tags": tags}
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, response_data)

              except Exception as e:
                  cfnresponse.send(event, context, cfnresponse.FAILED, {"Error": str(e)})

  TagResolver:
    Type: Custom::TagResolver
    Properties:
      ServiceToken: !GetAtt TagResolverFunction.Arn
      TagMode: !Ref TagMode
      DefaultTags:
        Environment: !FindInMap [DefaultTags, Values, Environment]
        Product: !FindInMap [DefaultTags, Values, Product]
        Owner: !FindInMap [DefaultTags, Values, Owner]
        createdBy: !FindInMap [DefaultTags, Values, createdBy]
        Project: !FindInMap [DefaultTags, Values, Project]
      CustomTags: !Ref CustomTags

  EBSCSIDriverRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If 
        - HasCustomEBSRoleName
        - !Ref EBSCSIDriverRoleName
        - !Sub 'promethium-prod-ebs-csi-driver-role'
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "arn:aws:iam::${AWS::AccountId}:oidc-provider/${OIDCProviderUrl}"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "${OIDCProviderUrl}:sub": "system:serviceaccount:kube-system:ebs-csi-controller-sa"
                    }
                  }
                }
              ]
            }
          - OIDCProviderUrl: !Ref OIDCProviderUrl
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy
      Path: /
      Tags: !GetAtt TagResolver.Tags
      Policies:
        - PolicyName: EBSCSIKMSPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Action:
                  - kms:CreateGrant
                  - kms:ListGrants
                  - kms:RevokeGrant
                Condition:
                  Bool:
                    kms:GrantIsForAWSResource: 'true'
                Effect: Allow
                Resource: !Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*'
              - Action:
                  - kms:Encrypt
                  - kms:Decrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                  - kms:DescribeKey
                Effect: Allow
                Resource: !Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*'

  EFSCSIDriverRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If 
        - HasCustomEFSRoleName
        - !Ref EFSCSIDriverRoleName
        - !Sub 'promethium-prod-efs-csi-driver-role'
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "arn:aws:iam::${AWS::AccountId}:oidc-provider/${OIDCProviderUrl}"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "${OIDCProviderUrl}:sub": "system:serviceaccount:kube-system:efs-csi-controller-sa"
                    }
                  }
                }
              ]
            }
          - OIDCProviderUrl: !Ref OIDCProviderUrl
      Path: /
      Tags: !GetAtt TagResolver.Tags
      Policies:
        - PolicyName: EFSCSIDriverPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Action:
                  - elasticfilesystem:DescribeAccessPoints
                  - elasticfilesystem:DescribeFileSystems
                  - elasticfilesystem:DescribeMountTargets
                  - ec2:DescribeAvailabilityZones
                Effect: Allow
                Resource: '*'
              - Action:
                  - elasticfilesystem:CreateAccessPoint
                Condition:
                  StringLike:
                    aws:RequestTag/cluster-name: !Ref ClusterName
                    aws:RequestTag/efs.csi.aws.com/cluster: 'true'
                Effect: Allow
                Resource: '*'
              - Action:
                  - elasticfilesystem:DeleteAccessPoint
                Condition:
                  StringLike:
                    aws:RequestTag/cluster-name: !Ref ClusterName
                    aws:RequestTag/efs.csi.aws.com/cluster: 'true'
                Effect: Allow
                Resource: '*'

  LoadBalancerControllerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If 
        - HasCustomLBRoleName
        - !Ref LoadBalancerControllerRoleName
        - !Sub 'promethium-prod-lb-controller-role'
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "arn:aws:iam::${AWS::AccountId}:oidc-provider/${OIDCProviderUrl}"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "${OIDCProviderUrl}:sub": "system:serviceaccount:kube-system:aws-load-balancer-controller"
                    }
                  }
                }
              ]
            }
          - OIDCProviderUrl: !Ref OIDCProviderUrl
      Path: /
      Tags: !GetAtt TagResolver.Tags

  LoadBalancerControllerPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub 'promethium-prod-lbcontroller-policy'
      Roles:
        - !Ref LoadBalancerControllerRole
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - iam:CreateServiceLinkedRole
            Resource: '*'
            Condition:
              StringEquals:
                iam:AWSServiceName: elasticloadbalancing.amazonaws.com
          - Effect: Allow
            Action:
              - ec2:DescribeAccountAttributes
              - ec2:DescribeAddresses
              - ec2:DescribeAvailabilityZones
              - ec2:DescribeInternetGateways
              - ec2:DescribeVpcs
              - ec2:DescribeVpcPeeringConnections
              - ec2:DescribeSubnets
              - ec2:DescribeSecurityGroups
              - ec2:DescribeInstances
              - ec2:DescribeNetworkInterfaces
              - ec2:DescribeTags
              - ec2:GetCoipPoolUsage
              - ec2:DescribeCoipPools
              - elasticloadbalancing:DescribeLoadBalancers
              - elasticloadbalancing:DescribeLoadBalancerAttributes
              - elasticloadbalancing:DescribeListeners
              - elasticloadbalancing:DescribeListenerCertificates
              - elasticloadbalancing:DescribeSSLPolicies
              - elasticloadbalancing:DescribeRules
              - elasticloadbalancing:DescribeTargetGroups
              - elasticloadbalancing:DescribeTargetGroupAttributes
              - elasticloadbalancing:DescribeTargetHealth
              - elasticloadbalancing:DescribeTags
            Resource: '*'
          - Effect: Allow
            Action:
              - cognito-idp:DescribeUserPoolClient
              - acm:ListCertificates
              - acm:DescribeCertificate
              - iam:ListServerCertificates
              - iam:GetServerCertificate
              - waf-regional:GetWebACL
              - waf-regional:GetWebACLForResource
              - waf-regional:AssociateWebACL
              - waf-regional:DisassociateWebACL
              - wafv2:GetWebACL
              - wafv2:GetWebACLForResource
              - wafv2:AssociateWebACL
              - wafv2:DisassociateWebACL
              - shield:GetSubscriptionState
              - shield:DescribeProtection
              - shield:CreateProtection
              - shield:DeleteProtection
            Resource: '*'
          - Effect: Allow
            Action:
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:RevokeSecurityGroupIngress
            Resource: '*'
          - Effect: Allow
            Action:
              - ec2:CreateSecurityGroup
            Resource: '*'
          - Effect: Allow
            Action:
              - ec2:CreateTags
            Resource: 'arn:aws:ec2:*:*:security-group/*'
            Condition:
              StringEquals:
                ec2:CreateAction: CreateSecurityGroup
              'Null':
                'aws:RequestTag/elbv2.k8s.aws/cluster': 'false'
          - Effect: Allow
            Action:
              - ec2:CreateTags
              - ec2:DeleteTags
            Resource: 'arn:aws:ec2:*:*:security-group/*'
            Condition:
              'Null':
                'aws:RequestTag/elbv2.k8s.aws/cluster': 'true'
                'aws:ResourceTag/elbv2.k8s.aws/cluster': 'false'
          - Effect: Allow
            Action:
              - ec2:AuthorizeSecurityGroupIngress
              - ec2:RevokeSecurityGroupIngress
              - ec2:DeleteSecurityGroup
            Resource: '*'
            Condition:
              'Null':
                'aws:ResourceTag/elbv2.k8s.aws/cluster': 'false'
          - Effect: Allow
            Action:
              - elasticloadbalancing:CreateLoadBalancer
              - elasticloadbalancing:CreateTargetGroup
            Resource: '*'
            Condition:
              'Null':
                'aws:RequestTag/elbv2.k8s.aws/cluster': 'false'
          - Effect: Allow
            Action:
              - elasticloadbalancing:CreateListener
              - elasticloadbalancing:DeleteListener
              - elasticloadbalancing:CreateRule
              - elasticloadbalancing:DeleteRule
            Resource: '*'
          - Effect: Allow
            Action:
              - elasticloadbalancing:AddTags
              - elasticloadbalancing:RemoveTags
            Resource:
              - 'arn:aws:elasticloadbalancing:*:*:targetgroup/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:loadbalancer/net/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:loadbalancer/app/*/*'
            Condition:
              'Null':
                'aws:RequestTag/elbv2.k8s.aws/cluster': 'true'
                'aws:ResourceTag/elbv2.k8s.aws/cluster': 'false'
          - Effect: Allow
            Action:
              - elasticloadbalancing:AddTags
              - elasticloadbalancing:RemoveTags
            Resource:
              - 'arn:aws:elasticloadbalancing:*:*:listener/net/*/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:listener/app/*/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:listener-rule/net/*/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:listener-rule/app/*/*/*'
          - Effect: Allow
            Action:
              - elasticloadbalancing:ModifyLoadBalancerAttributes
              - elasticloadbalancing:SetIpAddressType
              - elasticloadbalancing:SetSecurityGroups
              - elasticloadbalancing:SetSubnets
              - elasticloadbalancing:DeleteLoadBalancer
              - elasticloadbalancing:ModifyTargetGroup
              - elasticloadbalancing:ModifyTargetGroupAttributes
              - elasticloadbalancing:DeleteTargetGroup
            Resource: '*'
            Condition:
              'Null':
                'aws:ResourceTag/elbv2.k8s.aws/cluster': 'false'
          - Effect: Allow
            Action:
              - elasticloadbalancing:AddTags
            Resource:
              - 'arn:aws:elasticloadbalancing:*:*:targetgroup/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:loadbalancer/net/*/*'
              - 'arn:aws:elasticloadbalancing:*:*:loadbalancer/app/*/*'
            Condition:
              StringEquals:
                elasticloadbalancing:CreateAction:
                  - CreateTargetGroup
                  - CreateLoadBalancer
              'Null':
                'aws:RequestTag/elbv2.k8s.aws/cluster': 'false'
          - Effect: Allow
            Action:
              - elasticloadbalancing:RegisterTargets
              - elasticloadbalancing:DeregisterTargets
            Resource: 'arn:aws:elasticloadbalancing:*:*:targetgroup/*/*'
          - Effect: Allow
            Action:
              - elasticloadbalancing:SetWebAcl
              - elasticloadbalancing:ModifyListener
              - elasticloadbalancing:AddListenerCertificates
              - elasticloadbalancing:RemoveListenerCertificates
              - elasticloadbalancing:ModifyRule
            Resource: '*'

  ClusterAutoscalerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If 
        - HasCustomCARoleName
        - !Ref ClusterAutoscalerRoleName
        - !Sub 'promethium-prod-cluster-autoscaler-role'
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "arn:aws:iam::${AWS::AccountId}:oidc-provider/${OIDCProviderUrl}"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "${OIDCProviderUrl}:sub": "system:serviceaccount:kube-system:cluster-autoscaler"
                    }
                  }
                }
              ]
            }
          - OIDCProviderUrl: !Ref OIDCProviderUrl
      Path: /
      Tags: !GetAtt TagResolver.Tags
      Policies:
        - PolicyName: ClusterAutoscalerPolicy
          PolicyDocument:
            Fn::Sub:
              - |
                {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Action": [
                        "autoscaling:SetDesiredCapacity",
                        "autoscaling:TerminateInstanceInAutoScalingGroup"
                      ],
                      "Condition": {
                        "StringEquals": {
                          "aws:ResourceTag/k8s.io/cluster-autoscaler/${ClusterName}": "owned"
                        }
                      },
                      "Effect": "Allow",
                      "Resource": "*",
                      "Sid": "ScalingActions"
                    },
                    {
                      "Action": [
                        "autoscaling:DescribeAutoScalingGroups",
                        "autoscaling:DescribeAutoScalingInstances",
                        "autoscaling:DescribeLaunchConfigurations",
                        "autoscaling:DescribeScalingActivities",
                        "ec2:DescribeImages",
                        "ec2:DescribeInstanceTypes",
                        "ec2:DescribeLaunchTemplateVersions",
                        "ec2:GetInstanceTypesFromInstanceRequirements",
                        "eks:DescribeNodegroup"
                      ],
                      "Effect": "Allow",
                      "Resource": "*",
                      "Sid": "ReadOnlyActions"
                    }
                  ]
                }
              - ClusterName: !Ref ClusterName

  EKSClusterRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If 
        - HasCustomEKSClusterRoleName
        - !Ref EKSClusterRoleName
        - !Sub 'promethium-prod-eks-cluster-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: eks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
        - arn:aws:iam::aws:policy/AmazonEKSVPCResourceController
      Path: /
      Tags: !GetAtt TagResolver.Tags

  EKSWorkerNodeRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If 
        - HasCustomEKSWorkerRoleName
        - !Ref EKSWorkerNodeRoleName
        - !Sub 'promethium-prod-eks-worker-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
        - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Path: /
      Tags: !GetAtt TagResolver.Tags
      Policies:
        - PolicyName: WorkerKMSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Action:
                  - kms:Encrypt
                  - kms:Decrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                  - kms:DescribeKey
                Effect: Allow
                Resource: !Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*'

  PGBackupServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If 
        - HasCustomPGBackupRoleName
        - !Ref PGBackupServiceRoleName
        - !Sub 'promethium-prod-pg-backup-role'
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "arn:aws:iam::${AWS::AccountId}:oidc-provider/${OIDCProviderUrl}"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "${OIDCProviderUrl}:sub": [
                        "system:serviceaccount:intelligentedge:s3-backup-sa",
                        "system:serviceaccount:intelligentedge:sa-ecr-registry",
                        "system:serviceaccount:cluster-management:sa-ecr-registry"
                      ]
                    }
                  }
                }
              ]
            }
          - OIDCProviderUrl: !Ref OIDCProviderUrl
      Path: /
      Tags: !GetAtt TagResolver.Tags
      Policies:
        - PolicyName: PGBackupPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                Effect: Allow
                Resource: !Sub 'arn:aws:s3:::promethium-postgres-backups-*/*'
              - Action:
                  - kms:Encrypt
                  - kms:Decrypt
                  - kms:ReEncrypt*
                  - kms:GenerateDataKey*
                  - kms:DescribeKey
                Effect: Allow
                Resource: !Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*'
              - Action:
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:GetRepositoryPolicy
                  - ecr:DescribeRepositories
                  - ecr:ListImages
                  - ecr:DescribeImages
                  - ecr:BatchGetImage
                  - ecr:GetLifecyclePolicy
                  - ecr:GetLifecyclePolicyPreview
                  - ecr:ListTagsForResource
                  - ecr:DescribeImageScanFindings
                Effect: Allow
                Resource: '*'

  GlueTrinoServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If 
        - HasCustomGlueTrinoRoleName
        - !Ref GlueTrinoServiceRoleName
        - !Sub 'promethium-prod-glue-trino-role'
      AssumeRolePolicyDocument:
        Fn::Sub:
          - |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "arn:aws:iam::${AWS::AccountId}:oidc-provider/${OIDCProviderUrl}"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "${OIDCProviderUrl}:sub": "system:serviceaccount:intelligentedge:trino-sa"
                    }
                  }
                }
              ]
            }
          - OIDCProviderUrl: !Ref OIDCProviderUrl
      Path: /
      Tags: !GetAtt TagResolver.Tags
      Policies:
        - PolicyName: GlueTrinoPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Action:
                  - glue:GetDatabase
                  - glue:GetDatabases
                  - glue:GetTable
                  - glue:GetTables
                  - glue:GetPartition
                  - glue:GetPartitions
                  - glue:BatchCreatePartition
                  - glue:CreateTable
                  - glue:UpdateTable
                  - glue:DeleteTable
                  - glue:BatchDeleteTable
                  - glue:DeleteDatabase
                  - glue:GetCrawler
                  - glue:DeleteCrawler
                  - glue:StopCrawler
                  - glue:UpdateCrawler
                  - glue:StartCrawler
                  - glue:BatchGetPartition
                Effect: Allow
                Resource:
                  - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:database/*'
                  - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:table/*'
                  - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:catalog'
                  - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:userDefinedFunction/*/*'
                  - !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:crawler/*'
              - Action:
                  - glue:GetCrawlers
                  - glue:ListCrawlers
                  - glue:CreateDatabase
                  - glue:CreateCrawler
                Effect: Allow
                Resource: '*'
              - Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:GetObjectTagging
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                  - s3:GetObjectVersion
                  - s3:GetObjectVersionTagging
                  - s3:GetObjectACL
                  - s3:PutObjectACL
                  - s3:ListBucket
                Effect: Allow
                Resource:
                  - 'arn:aws:s3:::*'
                  - 'arn:aws:s3:::*/*'
              - Action:
                  - kms:Encrypt
                  - kms:Decrypt
                  - kms:GenerateDataKey
                  - kms:DescribeKey
                Effect: Allow
                Resource: !Sub 'arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/*'
              - Action:
                  - iam:PassRole
                Effect: Allow
                Resource: !Sub 'arn:aws:iam::${AWS::AccountId}:role/AWSGlueServiceRoleDefault'

Outputs:
  EBSCSIDriverRoleArn:
    Description: ARN of the EBS CSI Driver role
    Value: !GetAtt EBSCSIDriverRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-EBSCSIRoleArn

  EFSCSIDriverRoleArn:
    Description: ARN of the EFS CSI Driver role
    Value: !GetAtt EFSCSIDriverRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-EFSCSIRoleArn

  LoadBalancerControllerRoleArn:
    Description: ARN of the Load Balancer Controller role
    Value: !GetAtt LoadBalancerControllerRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-LBRoleArn

  ClusterAutoscalerRoleArn:
    Description: ARN of the Cluster Autoscaler role
    Value: !GetAtt ClusterAutoscalerRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-CARoleArn

  EKSClusterRoleArn:
    Description: ARN of the EKS Cluster role
    Value: !GetAtt EKSClusterRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-EKSClusterRoleArn

  EKSWorkerNodeRoleArn:
    Description: ARN of the EKS Worker Node role
    Value: !GetAtt EKSWorkerNodeRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-EKSWorkerRoleArn

  PGBackupServiceRoleArn:
    Description: ARN of the PostgreSQL Backup Service role
    Value: !GetAtt PGBackupServiceRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-PGBackupRoleArn

  GlueTrinoServiceRoleArn:
    Description: ARN of the Glue Trino Service role
    Value: !GetAtt GlueTrinoServiceRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-GlueTrinoRoleArn
